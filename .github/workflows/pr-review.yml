name: ğŸ¤– AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  ai-review:
    name: AI Code Review
    runs-on: ubuntu-latest

    # ãƒ‰ãƒ©ãƒ•ãƒˆPRã¯ã‚¹ã‚­ãƒƒãƒ—
    if: github.event.pull_request.draft == false

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          # PRå…¨ä½“ã®å¤‰æ›´ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€ååˆ†ãªå±¥æ­´ã‚’å–å¾—
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci

      - name: ğŸ”¨ Build TypeScript
        run: |
          npm run build
          echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†"
          ls -la dist/
          echo "ğŸ“„ github-action.js ã®å…ˆé ­ç¢ºèª:"
          head -20 dist/github-action.js

      - name: ğŸ¤– Run AI PR Review
        id: ai-review
        run: |
          # TypeScriptã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ã‹ã‚‰å®Ÿè¡Œï¼ˆES Moduleå¯¾å¿œï¼‰
          echo "ğŸ” GitHub Actionsç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯"
          echo "GITHUB_ACTIONS: $GITHUB_ACTIONS"
          echo "GITHUB_TOKEN: ${GITHUB_TOKEN:0:10}..."
          echo "OPENAI_API_KEY: ${OPENAI_API_KEY:0:10}..."
          echo "ğŸš€ AI PR Reviewé–‹å§‹"
          node dist/github-action.js
        env:
          # GitHub Tokenï¼ˆPRæ›¸ãè¾¼ã¿æ¨©é™ä»˜ãï¼‰
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          # AI Providerè¨­å®šï¼ˆãŠå¥½ã¿ã®AIãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’é¸æŠï¼‰
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          # GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨­å®š
          AI_REVIEW_ENABLED: 'true'
          AI_REVIEW_MAX_FILES: '20'
          AI_REVIEW_MAX_LINES: '5000'

          # ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«è¨­å®š
          LOG_LEVEL: 'info'

      - name: ğŸ“Š Upload review artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-review-results
          path: |
            logs/
            review-*.json
          retention-days: 7

      - name: ğŸ“‹ Comment review summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            // ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã®å‡ºåŠ›å€¤ã‚’å–å¾—
            const reviewId = '${{ steps.ai-review.outputs.review-id }}';
            const totalComments = '${{ steps.ai-review.outputs.total-comments }}';
            const overallScore = '${{ steps.ai-review.outputs.overall-score }}';
            const recommendation = '${{ steps.ai-review.outputs.recommendation }}';
            const error = '${{ steps.ai-review.outputs.error }}';

            if (error) {
              // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## âŒ AI ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼\n\n` +
                      `AI ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š\n\n` +
                      `\`\`\`\n${error}\n\`\`\`\n\n` +
                      `è©³ç´°ã«ã¤ã„ã¦ã¯ã€[Actions ã®ãƒ­ã‚°](${context.payload.repository.html_url}/actions/runs/${context.runId})ã‚’ã”ç¢ºèªãã ã•ã„ã€‚`
              });
            } else {
              // æˆåŠŸã®å ´åˆã¯åŸºæœ¬æƒ…å ±ã‚’ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆè©³ç´°ã¯PRãƒ¬ãƒ“ãƒ¥ãƒ¼ã«æŠ•ç¨¿æ¸ˆã¿ï¼‰
              const scoreEmoji = overallScore >= 8 ? 'ğŸŸ¢' : overallScore >= 6 ? 'ğŸŸ¡' : 'ğŸ”´';
              const recommendationEmoji = {
                'approve': 'âœ…',
                'requestChanges': 'ğŸ”„',
                'comment': 'ğŸ’¬'
              }[recommendation] || 'ğŸ’¬';

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ${scoreEmoji} AI ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†\n\n` +
                      `- **ã‚¹ã‚³ã‚¢**: ${overallScore}/10\n` +
                      `- **æ¨å¥¨**: ${recommendationEmoji} ${recommendation}\n` +
                      `- **æ¤œå‡ºå•é¡Œ**: ${totalComments}ä»¶\n\n` +
                      `è©³ç´°ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã¯ä¸Šè¨˜ã‚’ã”ç¢ºèªãã ã•ã„ã€‚`
              });
            }

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”’ Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“Š Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ” Audit dependencies
        run: |
          npm audit --audit-level=moderate

      - name: ğŸ“¦ Check for outdated packages
        run: |
          npm outdated || true  # outdatedãŒã‚ã£ã¦ã‚‚å¤±æ•—ã•ã›ãªã„
